.include "macros.inc"

.section .sdata, "wa"
.balign 0x8
.global __OSCurrHeap
__OSCurrHeap:
	.long 0xFFFFFFFF

.section .sbss, "wa"
.balign 0x8
ArenaEnd:
	.skip 0x4
ArenaStart:
	.skip 0x4
NumHeaps:
	.skip 0x4
HeapArray:
	.skip 0x4

.section .text, "ax"
DLInsert:
/* 800ED8A0 000E87A0  7C 67 1B 78 */	mr r7, r3
/* 800ED8A4 000E87A4  38 C0 00 00 */	li r6, 0
/* 800ED8A8 000E87A8  48 00 00 14 */	b lbl_800ED8BC
lbl_800ED8AC:
/* 800ED8AC 000E87AC  7C 04 38 40 */	cmplw r4, r7
/* 800ED8B0 000E87B0  40 81 00 14 */	ble lbl_800ED8C4
/* 800ED8B4 000E87B4  7C E6 3B 78 */	mr r6, r7
/* 800ED8B8 000E87B8  80 E7 00 04 */	lwz r7, 4(r7)
lbl_800ED8BC:
/* 800ED8BC 000E87BC  2C 07 00 00 */	cmpwi r7, 0
/* 800ED8C0 000E87C0  40 82 FF EC */	bne lbl_800ED8AC
lbl_800ED8C4:
/* 800ED8C4 000E87C4  2C 07 00 00 */	cmpwi r7, 0
/* 800ED8C8 000E87C8  90 E4 00 04 */	stw r7, 4(r4)
/* 800ED8CC 000E87CC  90 C4 00 00 */	stw r6, 0(r4)
/* 800ED8D0 000E87D0  41 82 00 38 */	beq lbl_800ED908
/* 800ED8D4 000E87D4  90 87 00 00 */	stw r4, 0(r7)
/* 800ED8D8 000E87D8  80 A4 00 08 */	lwz r5, 8(r4)
/* 800ED8DC 000E87DC  7C 04 2A 14 */	add r0, r4, r5
/* 800ED8E0 000E87E0  7C 00 38 40 */	cmplw r0, r7
/* 800ED8E4 000E87E4  40 82 00 24 */	bne lbl_800ED908
/* 800ED8E8 000E87E8  80 07 00 08 */	lwz r0, 8(r7)
/* 800ED8EC 000E87EC  7C 05 02 14 */	add r0, r5, r0
/* 800ED8F0 000E87F0  90 04 00 08 */	stw r0, 8(r4)
/* 800ED8F4 000E87F4  80 E7 00 04 */	lwz r7, 4(r7)
/* 800ED8F8 000E87F8  2C 07 00 00 */	cmpwi r7, 0
/* 800ED8FC 000E87FC  90 E4 00 04 */	stw r7, 4(r4)
/* 800ED900 000E8800  41 82 00 08 */	beq lbl_800ED908
/* 800ED904 000E8804  90 87 00 00 */	stw r4, 0(r7)
lbl_800ED908:
/* 800ED908 000E8808  2C 06 00 00 */	cmpwi r6, 0
/* 800ED90C 000E880C  41 82 00 38 */	beq lbl_800ED944
/* 800ED910 000E8810  90 86 00 04 */	stw r4, 4(r6)
/* 800ED914 000E8814  80 A6 00 08 */	lwz r5, 8(r6)
/* 800ED918 000E8818  7C 06 2A 14 */	add r0, r6, r5
/* 800ED91C 000E881C  7C 00 20 40 */	cmplw r0, r4
/* 800ED920 000E8820  4C 82 00 20 */	bnelr 
/* 800ED924 000E8824  80 04 00 08 */	lwz r0, 8(r4)
/* 800ED928 000E8828  2C 07 00 00 */	cmpwi r7, 0
/* 800ED92C 000E882C  7C 05 02 14 */	add r0, r5, r0
/* 800ED930 000E8830  90 06 00 08 */	stw r0, 8(r6)
/* 800ED934 000E8834  90 E6 00 04 */	stw r7, 4(r6)
/* 800ED938 000E8838  4D 82 00 20 */	beqlr 
/* 800ED93C 000E883C  90 C7 00 00 */	stw r6, 0(r7)
/* 800ED940 000E8840  4E 80 00 20 */	blr 
lbl_800ED944:
/* 800ED944 000E8844  7C 83 23 78 */	mr r3, r4
/* 800ED948 000E8848  4E 80 00 20 */	blr 

.global OSAllocFromHeap
OSAllocFromHeap:
/* 800ED94C 000E884C  1C 63 00 0C */	mulli r3, r3, 0xc
/* 800ED950 000E8850  80 AD 9B E4 */	lwz r5, HeapArray-_SDA_BASE_(r13)
/* 800ED954 000E8854  38 04 00 3F */	addi r0, r4, 0x3f
/* 800ED958 000E8858  7C A5 1A 14 */	add r5, r5, r3
/* 800ED95C 000E885C  54 04 00 34 */	rlwinm r4, r0, 0, 0, 0x1a
/* 800ED960 000E8860  80 65 00 04 */	lwz r3, 4(r5)
/* 800ED964 000E8864  7C 66 1B 78 */	mr r6, r3
/* 800ED968 000E8868  48 00 00 14 */	b lbl_800ED97C
lbl_800ED96C:
/* 800ED96C 000E886C  80 06 00 08 */	lwz r0, 8(r6)
/* 800ED970 000E8870  7C 04 00 00 */	cmpw r4, r0
/* 800ED974 000E8874  40 81 00 10 */	ble lbl_800ED984
/* 800ED978 000E8878  80 C6 00 04 */	lwz r6, 4(r6)
lbl_800ED97C:
/* 800ED97C 000E887C  2C 06 00 00 */	cmpwi r6, 0
/* 800ED980 000E8880  40 82 FF EC */	bne lbl_800ED96C
lbl_800ED984:
/* 800ED984 000E8884  2C 06 00 00 */	cmpwi r6, 0
/* 800ED988 000E8888  40 82 00 0C */	bne lbl_800ED994
/* 800ED98C 000E888C  38 60 00 00 */	li r3, 0
/* 800ED990 000E8890  4E 80 00 20 */	blr 
lbl_800ED994:
/* 800ED994 000E8894  80 06 00 08 */	lwz r0, 8(r6)
/* 800ED998 000E8898  7C 04 00 50 */	subf r0, r4, r0
/* 800ED99C 000E889C  28 00 00 40 */	cmplwi r0, 0x40
/* 800ED9A0 000E88A0  40 80 00 3C */	bge lbl_800ED9DC
/* 800ED9A4 000E88A4  80 86 00 04 */	lwz r4, 4(r6)
/* 800ED9A8 000E88A8  2C 04 00 00 */	cmpwi r4, 0
/* 800ED9AC 000E88AC  41 82 00 0C */	beq lbl_800ED9B8
/* 800ED9B0 000E88B0  80 06 00 00 */	lwz r0, 0(r6)
/* 800ED9B4 000E88B4  90 04 00 00 */	stw r0, 0(r4)
lbl_800ED9B8:
/* 800ED9B8 000E88B8  80 86 00 00 */	lwz r4, 0(r6)
/* 800ED9BC 000E88BC  2C 04 00 00 */	cmpwi r4, 0
/* 800ED9C0 000E88C0  40 82 00 0C */	bne lbl_800ED9CC
/* 800ED9C4 000E88C4  80 66 00 04 */	lwz r3, 4(r6)
/* 800ED9C8 000E88C8  48 00 00 0C */	b lbl_800ED9D4
lbl_800ED9CC:
/* 800ED9CC 000E88CC  80 06 00 04 */	lwz r0, 4(r6)
/* 800ED9D0 000E88D0  90 04 00 04 */	stw r0, 4(r4)
lbl_800ED9D4:
/* 800ED9D4 000E88D4  90 65 00 04 */	stw r3, 4(r5)
/* 800ED9D8 000E88D8  48 00 00 44 */	b lbl_800EDA1C
lbl_800ED9DC:
/* 800ED9DC 000E88DC  90 86 00 08 */	stw r4, 8(r6)
/* 800ED9E0 000E88E0  7C 86 22 14 */	add r4, r6, r4
/* 800ED9E4 000E88E4  90 04 00 08 */	stw r0, 8(r4)
/* 800ED9E8 000E88E8  80 06 00 00 */	lwz r0, 0(r6)
/* 800ED9EC 000E88EC  90 04 00 00 */	stw r0, 0(r4)
/* 800ED9F0 000E88F0  80 66 00 04 */	lwz r3, 4(r6)
/* 800ED9F4 000E88F4  2C 03 00 00 */	cmpwi r3, 0
/* 800ED9F8 000E88F8  90 64 00 04 */	stw r3, 4(r4)
/* 800ED9FC 000E88FC  41 82 00 08 */	beq lbl_800EDA04
/* 800EDA00 000E8900  90 83 00 00 */	stw r4, 0(r3)
lbl_800EDA04:
/* 800EDA04 000E8904  80 64 00 00 */	lwz r3, 0(r4)
/* 800EDA08 000E8908  2C 03 00 00 */	cmpwi r3, 0
/* 800EDA0C 000E890C  41 82 00 0C */	beq lbl_800EDA18
/* 800EDA10 000E8910  90 83 00 04 */	stw r4, 4(r3)
/* 800EDA14 000E8914  48 00 00 08 */	b lbl_800EDA1C
lbl_800EDA18:
/* 800EDA18 000E8918  90 85 00 04 */	stw r4, 4(r5)
lbl_800EDA1C:
/* 800EDA1C 000E891C  80 65 00 08 */	lwz r3, 8(r5)
/* 800EDA20 000E8920  38 00 00 00 */	li r0, 0
/* 800EDA24 000E8924  90 66 00 04 */	stw r3, 4(r6)
/* 800EDA28 000E8928  2C 03 00 00 */	cmpwi r3, 0
/* 800EDA2C 000E892C  90 06 00 00 */	stw r0, 0(r6)
/* 800EDA30 000E8930  41 82 00 08 */	beq lbl_800EDA38
/* 800EDA34 000E8934  90 C3 00 00 */	stw r6, 0(r3)
lbl_800EDA38:
/* 800EDA38 000E8938  90 C5 00 08 */	stw r6, 8(r5)
/* 800EDA3C 000E893C  38 66 00 20 */	addi r3, r6, 0x20
/* 800EDA40 000E8940  4E 80 00 20 */	blr 

.global OSFreeToHeap
OSFreeToHeap:
/* 800EDA44 000E8944  94 21 FF F0 */	stwu r1, -0x10(r1)
/* 800EDA48 000E8948  7C 08 02 A6 */	mflr r0
/* 800EDA4C 000E894C  38 84 FF E0 */	addi r4, r4, -32
/* 800EDA50 000E8950  90 01 00 14 */	stw r0, 0x14(r1)
/* 800EDA54 000E8954  1C 03 00 0C */	mulli r0, r3, 0xc
/* 800EDA58 000E8958  93 E1 00 0C */	stw r31, 0xc(r1)
/* 800EDA5C 000E895C  80 AD 9B E4 */	lwz r5, HeapArray-_SDA_BASE_(r13)
/* 800EDA60 000E8960  80 C4 00 04 */	lwz r6, 4(r4)
/* 800EDA64 000E8964  7F E5 02 14 */	add r31, r5, r0
/* 800EDA68 000E8968  2C 06 00 00 */	cmpwi r6, 0
/* 800EDA6C 000E896C  80 7F 00 08 */	lwz r3, 8(r31)
/* 800EDA70 000E8970  41 82 00 0C */	beq lbl_800EDA7C
/* 800EDA74 000E8974  80 04 00 00 */	lwz r0, 0(r4)
/* 800EDA78 000E8978  90 06 00 00 */	stw r0, 0(r6)
lbl_800EDA7C:
/* 800EDA7C 000E897C  80 A4 00 00 */	lwz r5, 0(r4)
/* 800EDA80 000E8980  2C 05 00 00 */	cmpwi r5, 0
/* 800EDA84 000E8984  40 82 00 0C */	bne lbl_800EDA90
/* 800EDA88 000E8988  80 64 00 04 */	lwz r3, 4(r4)
/* 800EDA8C 000E898C  48 00 00 0C */	b lbl_800EDA98
lbl_800EDA90:
/* 800EDA90 000E8990  80 04 00 04 */	lwz r0, 4(r4)
/* 800EDA94 000E8994  90 05 00 04 */	stw r0, 4(r5)
lbl_800EDA98:
/* 800EDA98 000E8998  90 7F 00 08 */	stw r3, 8(r31)
/* 800EDA9C 000E899C  80 7F 00 04 */	lwz r3, 4(r31)
/* 800EDAA0 000E89A0  4B FF FE 01 */	bl DLInsert
/* 800EDAA4 000E89A4  90 7F 00 04 */	stw r3, 4(r31)
/* 800EDAA8 000E89A8  83 E1 00 0C */	lwz r31, 0xc(r1)
/* 800EDAAC 000E89AC  80 01 00 14 */	lwz r0, 0x14(r1)
/* 800EDAB0 000E89B0  7C 08 03 A6 */	mtlr r0
/* 800EDAB4 000E89B4  38 21 00 10 */	addi r1, r1, 0x10
/* 800EDAB8 000E89B8  4E 80 00 20 */	blr 

.global OSSetCurrentHeap
OSSetCurrentHeap:
/* 800EDABC 000E89BC  80 0D 83 60 */	lwz r0, __OSCurrHeap-_SDA_BASE_(r13)
/* 800EDAC0 000E89C0  90 6D 83 60 */	stw r3, __OSCurrHeap-_SDA_BASE_(r13)
/* 800EDAC4 000E89C4  7C 03 03 78 */	mr r3, r0
/* 800EDAC8 000E89C8  4E 80 00 20 */	blr 

.global OSInitAlloc
OSInitAlloc:
/* 800EDACC 000E89CC  1C E5 00 0C */	mulli r7, r5, 0xc
/* 800EDAD0 000E89D0  90 6D 9B E4 */	stw r3, HeapArray-_SDA_BASE_(r13)
/* 800EDAD4 000E89D4  39 00 00 00 */	li r8, 0
/* 800EDAD8 000E89D8  90 AD 9B E0 */	stw r5, NumHeaps-_SDA_BASE_(r13)
/* 800EDADC 000E89DC  38 C0 00 00 */	li r6, 0
/* 800EDAE0 000E89E0  38 A0 FF FF */	li r5, -1
/* 800EDAE4 000E89E4  38 60 00 00 */	li r3, 0
/* 800EDAE8 000E89E8  48 00 00 20 */	b lbl_800EDB08
lbl_800EDAEC:
/* 800EDAEC 000E89EC  80 0D 9B E4 */	lwz r0, HeapArray-_SDA_BASE_(r13)
/* 800EDAF0 000E89F0  39 08 00 01 */	addi r8, r8, 1
/* 800EDAF4 000E89F4  7C A6 01 2E */	stwx r5, r6, r0
/* 800EDAF8 000E89F8  7D 20 32 14 */	add r9, r0, r6
/* 800EDAFC 000E89FC  38 C6 00 0C */	addi r6, r6, 0xc
/* 800EDB00 000E8A00  90 69 00 08 */	stw r3, 8(r9)
/* 800EDB04 000E8A04  90 69 00 04 */	stw r3, 4(r9)
lbl_800EDB08:
/* 800EDB08 000E8A08  80 0D 9B E0 */	lwz r0, NumHeaps-_SDA_BASE_(r13)
/* 800EDB0C 000E8A0C  7C 08 00 00 */	cmpw r8, r0
/* 800EDB10 000E8A10  41 80 FF DC */	blt lbl_800EDAEC
/* 800EDB14 000E8A14  80 6D 9B E4 */	lwz r3, HeapArray-_SDA_BASE_(r13)
/* 800EDB18 000E8A18  54 80 00 34 */	rlwinm r0, r4, 0, 0, 0x1a
/* 800EDB1C 000E8A1C  38 80 FF FF */	li r4, -1
/* 800EDB20 000E8A20  90 0D 9B D8 */	stw r0, ArenaEnd-_SDA_BASE_(r13)
/* 800EDB24 000E8A24  7C 63 3A 14 */	add r3, r3, r7
/* 800EDB28 000E8A28  38 03 00 1F */	addi r0, r3, 0x1f
/* 800EDB2C 000E8A2C  90 8D 83 60 */	stw r4, __OSCurrHeap-_SDA_BASE_(r13)
/* 800EDB30 000E8A30  54 03 00 34 */	rlwinm r3, r0, 0, 0, 0x1a
/* 800EDB34 000E8A34  90 6D 9B DC */	stw r3, ArenaStart-_SDA_BASE_(r13)
/* 800EDB38 000E8A38  4E 80 00 20 */	blr 

.global OSCreateHeap
OSCreateHeap:
/* 800EDB3C 000E8A3C  80 CD 9B E0 */	lwz r6, NumHeaps-_SDA_BASE_(r13)
/* 800EDB40 000E8A40  38 03 00 1F */	addi r0, r3, 0x1f
/* 800EDB44 000E8A44  54 07 00 34 */	rlwinm r7, r0, 0, 0, 0x1a
/* 800EDB48 000E8A48  54 84 00 34 */	rlwinm r4, r4, 0, 0, 0x1a
/* 800EDB4C 000E8A4C  80 AD 9B E4 */	lwz r5, HeapArray-_SDA_BASE_(r13)
/* 800EDB50 000E8A50  38 60 00 00 */	li r3, 0
/* 800EDB54 000E8A54  7C C9 03 A6 */	mtctr r6
/* 800EDB58 000E8A58  2C 06 00 00 */	cmpwi r6, 0
/* 800EDB5C 000E8A5C  40 81 00 44 */	ble lbl_800EDBA0
lbl_800EDB60:
/* 800EDB60 000E8A60  80 05 00 00 */	lwz r0, 0(r5)
/* 800EDB64 000E8A64  2C 00 00 00 */	cmpwi r0, 0
/* 800EDB68 000E8A68  40 80 00 2C */	bge lbl_800EDB94
/* 800EDB6C 000E8A6C  7C 07 20 50 */	subf r0, r7, r4
/* 800EDB70 000E8A70  38 80 00 00 */	li r4, 0
/* 800EDB74 000E8A74  90 05 00 00 */	stw r0, 0(r5)
/* 800EDB78 000E8A78  90 87 00 00 */	stw r4, 0(r7)
/* 800EDB7C 000E8A7C  90 87 00 04 */	stw r4, 4(r7)
/* 800EDB80 000E8A80  80 05 00 00 */	lwz r0, 0(r5)
/* 800EDB84 000E8A84  90 07 00 08 */	stw r0, 8(r7)
/* 800EDB88 000E8A88  90 E5 00 04 */	stw r7, 4(r5)
/* 800EDB8C 000E8A8C  90 85 00 08 */	stw r4, 8(r5)
/* 800EDB90 000E8A90  4E 80 00 20 */	blr 
lbl_800EDB94:
/* 800EDB94 000E8A94  38 A5 00 0C */	addi r5, r5, 0xc
/* 800EDB98 000E8A98  38 63 00 01 */	addi r3, r3, 1
/* 800EDB9C 000E8A9C  42 00 FF C4 */	bdnz lbl_800EDB60
lbl_800EDBA0:
/* 800EDBA0 000E8AA0  38 60 FF FF */	li r3, -1
/* 800EDBA4 000E8AA4  4E 80 00 20 */	blr 
